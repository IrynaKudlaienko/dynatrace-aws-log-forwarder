{
  "name": "CLOUD_TRAIL",
  "displayName": "Cloud Trail Management Events / Logs",
  "rules": [
    {
      "aws": {
        "logContentParseAs": "json"
      },
      "sources": [
        {
          "sourceType": "logs",
          "source": "log_group",
          "condition": "$prefix('aws-cloudtrail-logs')"
        }
      ],
      "attributes": [
        {
          "key": "aws.service",
          "pattern": "'cloudtrail'"
        },
        {
          "key": "audit.action",
          "pattern": "log_content_parsed.eventName"
        },
        {
          "key": "audit.identity",
          "pattern": "log_content_parsed.userIdentity.arn"
        },
        {
          "key": "audit.result",
          "description":  "If a field errorCode exists, then return Failure.{errorCode}, else return Succeeded",
          "pattern": "if( log_content_parsed.errorCode==null, &'Succeeded', &[`Failed`, log_content_parsed.errorCode] | [? @!=null ] | join('.', @) , @)"
        },
        {
          "key": "severity",
          "pattern": "if( log_content_parsed.errorCode==null, &'INFO', &'ERROR', @)"
        },


        {
          "key": "aws.resource.id",
          "pattern": "TODO"
        },
        {
          "key": "aws.arn",
          "pattern": "TODO"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'AddRoleToDBCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'AddRoleToDBInstance', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'AddSourceIdentifierToSubscription', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },

        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'AddSourceIdentifierToSubscription', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'AddTagsToResource', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.resourceName])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'ApplyPendingMaintenanceAction', &dt_meid_rds_v2( log_content_parsed.requestParameters.resourceIdentifier), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'BacktrackDBCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },

        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'CreateDBCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'CreateDBClusterEndpoint', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },{
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'CreateDBClusterSnapshot', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'CreateDBInstance', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.responseElements.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'CreateDBInstanceReadReplica', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.responseElements.sourceDBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'CreateDBSnapshot', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'CreateEventSubscription', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.SourceIds[*].SourceId.dBClusterIdentifier ])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'CreateEventSubscription', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.SourceIds[*].SourceId.dBInstanceIdentifier  ])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'CreateGlobalCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.globalClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DeleteDBCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DeleteDBInstance', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DeleteDBInstanceAutomatedBackup', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.DbiResourceId])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DeleteGlobalCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.globalClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DeregisterDBProxyTargets', &TODOdt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifiers[*]])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeDBClusterBacktracks', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeDBClusterEndpoints', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeDBClusterBacktracks', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeDBClusters', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeDBClusterSnapshots', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeDBInstanceAutomatedBackups', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeDBInstances', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeDBLogFiles', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeDBSnapshots', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeEvents', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeEvents', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeGlobalClusters', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.globalClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribePendingMaintenanceActions', &dt_meid_rds_v2( log_content_parsed.requestParameters.resourceIdentifier), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DescribeValidDBInstanceModifications', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'DownloadDBLogFilePortion', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'FailoverDBCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'FailoverGlobalCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.globalClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'ListTagsForResource', &dt_meid_rds_v2( log_content_parsed.requestParameters.resourceName), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'ModifyDBCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'ModifyDBInstance', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'ModifyDBSnapshot', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.responseElements.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'ModifyGlobalCluster', &TODOdt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'PromoteReadReplica', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'PromoteReadReplicaDBCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RebootDBInstance', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RegisterDBProxyTargets', &TODOdt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifiers[*]])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RemoveFromGlobalCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RemoveRoleFromDBCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RemoveRoleFromDBInstance', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RemoveTagsFromResource', &dt_meid_supporting_service_v2( log_content_parsed.requestParameters.resourceName), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RestoreDBClusterFromS3', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RestoreDBClusterFromSnapshot', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RestoreDBClusterToPointInTime', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.targetDBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RestoreDBInstanceFromDBSnapshot', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RestoreDBInstanceFromS3', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'RestoreDBInstanceToPointInTime', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },

        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'StartActivityStream', &dt_meid_supporting_service_v2( log_content_parsed.requestParameters.resourceArn), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'StartDBCluster', &dt_meid_supporting_service_v2( 'Aurora', format('arn:aws:rds:{}:{}:cluster:{}', [region, account_id, log_content_parsed.requestParameters.dBClusterIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'StartDBInstance', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'StartDBInstanceAutomatedBackupsReplication', &dt_meid_rds_v2( log_content_parsed.requestParameters.sourceDBInstanceArn), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'StopActivityStream', &dt_meid_supporting_service_v2( log_content_parsed.requestParameters.resourceArn), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'StopDBCluster', &dt_meid_supporting_service_v2( log_content_parsed.requestParameters.dBClusterIdentifier), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'StopDBInstance', &dt_meid_rds_v2( format('arn:aws:rds:{}:{}:db:{}', [region, account_id, log_content_parsed.requestParameters.dBInstanceIdentifier])), &EmptyValue, @ )"
        },
        {
          "key": "dt.source_entity",
          "pattern": "if( log_content_parsed.eventName == 'StopDBInstanceAutomatedBackupsReplication', &dt_meid_rds_v2( log_content_parsed.requestParameters.sourceDBInstanceArn), &EmptyValue, @ )"
        }
      ]
    }
  ]
}
